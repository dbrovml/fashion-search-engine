{% extends "base.html" %}

{% block content %}
<section class="space-y-6">
    <div class="lg:grid lg:grid-cols-[minmax(0,320px)_1fr] lg:items-start lg:gap-8">
        <div class="space-y-6">
            <div class="bg-white shadow-sm border border-slate-200 rounded-2xl p-6">
                <form
                    id="search-form"
                    hx-post="/search"
                    hx-target="#results-content"
                    hx-swap="innerHTML"
                    hx-indicator="#search-spinner"
                    hx-encoding="multipart/form-data"
                    enctype="multipart/form-data"
                    class="space-y-4"
                >
                    <div>
                        <label for="q_text" class="block text-sm font-medium text-slate-700">
                            I'm looking for...
                        </label>
                        <input
                            type="text"
                            id="q_text"
                            name="q_text"
                            placeholder="e.g. emerald green satin midi dress"
                            class="mt-2 w-full rounded-xl border-slate-200 focus:border-emerald-500 focus:ring-emerald-500"
                        />
                        <p class="mt-2 text-xs text-slate-500">
                            Tip: combine attributes like shade, fabric, brand, or silhouette to improve your matches.
                        </p>
                    </div>
                    <div class="flex flex-col gap-4 md:flex-row md:items-center">
                        <div class="flex flex-1 flex-col gap-4 md:flex-row md:items-center">
                            <div>
                                <input
                                    type="file"
                                    id="q_image"
                                    name="q_image"
                                    accept="image/*"
                                    class="sr-only"
                                />
                                <label
                                    for="q_image"
                                    class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-600 transition hover:border-slate-400 hover:text-slate-900 md:w-auto"
                                >
                                    Upload reference
                                </label>
                            </div>
                            <button
                                type="submit"
                                class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-6 py-3 font-semibold text-white shadow-sm hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:ring-offset-2"
                            >
                                <span>Search</span>
                            </button>
                        </div>
                    </div>
            <div id="upload-preview" class="hidden">
                <div class="mt-3 rounded-2xl border border-slate-200 bg-white p-3">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Reference preview</p>
                    <div class="mt-3 flex max-h-64 items-center justify-center overflow-hidden rounded-xl border border-slate-100 bg-slate-50">
                        <img
                            id="upload-preview-img"
                            src=""
                            alt="Reference preview"
                            class="max-h-full max-w-full object-contain"
                        />
                    </div>
                </div>
            </div>
                </form>
            </div>
            <div id="query-panel">
                {% include "partials/query_panel.html" %}
            </div>
        </div>
        <div class="relative">
            <div id="results-container" class="relative">
                <div id="search-spinner" class="htmx-indicator absolute inset-0 items-center justify-center rounded-2xl bg-white/90 backdrop-blur">
                    <div class="flex items-center gap-3 text-slate-600">
                        <svg class="h-6 w-6 animate-spin text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 010 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"></path>
                        </svg>
                        <span>Fetching looks...</span>
                    </div>
                </div>
                <div id="results-content" class="results-body">
                    {% include "partials/results.html" %}
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("q_text");
    const searchForm = document.getElementById("search-form");
    const resultsContainer = document.getElementById("results-container");
    const imageInput = document.getElementById("q_image");
    const uploadPreview = document.getElementById("upload-preview");
    const uploadPreviewImg = document.getElementById("upload-preview-img");

    const clearUploadPreview = () => {
        if (uploadPreview) {
            uploadPreview.classList.add("hidden");
        }
        if (uploadPreviewImg) {
            uploadPreviewImg.removeAttribute("src");
        }
        if (imageInput) {
            imageInput.value = "";
        }
    };

    const showUploadPreview = (dataUrl) => {
        if (!uploadPreview || !uploadPreviewImg) return;
        uploadPreviewImg.src = dataUrl;
        uploadPreview.classList.remove("hidden");
    };

    if (imageInput) {
        imageInput.addEventListener("change", (event) => {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                clearUploadPreview();
                return;
            }
            const reader = new FileReader();
            reader.onload = (loadEvent) => {
                if (typeof loadEvent.target?.result === "string") {
                    showUploadPreview(loadEvent.target.result);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    const setLoadingState = (isLoading) => {
        if (!resultsContainer) return;
        resultsContainer.classList.toggle("is-loading", isLoading);
        if (isLoading) {
            clearUploadPreview();
        }
    };

    document.body.addEventListener("htmx:beforeRequest", function (event) {
        if (event.target.id === "search-form") {
            setLoadingState(true);
        }
    });

    const clearLoading = function (event) {
        const target = event.detail ? event.detail.target : null;
        if (target && target.id === "results-content") {
            setLoadingState(false);
        }
    };

    document.body.addEventListener("htmx:afterSwap", clearLoading);
    document.body.addEventListener("htmx:responseError", function () {
        setLoadingState(false);
    });

    if (!searchInput || !searchForm) return;

    searchInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            event.preventDefault();
            searchForm.requestSubmit();
        }
    });
});
</script>
{% endblock %}

