{% if error %}
<div class="col-span-3 text-center text-red-500 mt-8">
    <p>Error: {{ error }}</p>
</div>
{% elif products %}
<div class="grid grid-cols-3 gap-4">
    {% for product in products %}
    <div class="bg-white rounded-lg p-4 border border-gray-200 hover:border-gray-300 transition-colors product-card">
        <!-- Product Image -->
        {% if product.image_url %}
        <div class="mb-4 rounded-lg overflow-hidden bg-white aspect-[3/4] border border-gray-200 relative">
            {% if product.metadata.get('uri') %}
            <a href="{{ product.metadata.uri }}" target="_blank" rel="noopener noreferrer" class="absolute inset-0 block cursor-pointer">
                <img 
                    src="{{ product.image_url }}?crop=1" 
                    alt="{{ product.metadata.get('name', 'Product') }}"
                    class="product-image rounded-lg w-full h-full"
                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'300\'%3E%3Crect fill=\'%23f3f4f6\' width=\'300\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-family=\'sans-serif\' font-size=\'14\'%3ENo Image%3C/text%3E%3C/svg%3E'"
                >
            </a>
            {% else %}
            <img 
                src="{{ product.image_url }}?crop=1" 
                alt="{{ product.metadata.get('name', 'Product') }}"
                class="product-image rounded-lg absolute inset-0"
                onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'300\'%3E%3Crect fill=\'%23f3f4f6\' width=\'300\' height=\'300\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-family=\'sans-serif\' font-size=\'14\'%3ENo Image%3C/text%3E%3C/svg%3E'"
            >
            {% endif %}
        </div>
        {% else %}
        <div class="mb-4 rounded-lg overflow-hidden bg-white border border-gray-200 aspect-[3/4] flex items-center justify-center">
            <span class="text-gray-400">No Image</span>
        </div>
        {% endif %}

        <!-- Product Info -->
        <div class="space-y-1 text-center w-full">
            <h3 class="font-semibold text-gray-800 text-sm line-clamp-2">
                {% if product.metadata.get('uri') %}
                <a href="{{ product.metadata.uri }}" target="_blank" rel="noopener noreferrer" class="text-gray-800 hover:text-gray-600 hover:underline">
                    {{ product.metadata.get('name', 'Unknown Product') }}
                </a>
                {% else %}
                {{ product.metadata.get('name', 'Unknown Product') }}
                {% endif %}
            </h3>
            <p class="text-xs text-gray-600">
                {{ product.metadata.get('brand', 'Unknown Brand') }}
            </p>
            {% if product.metadata.get('price_formatted') %}
            <p class="text-sm font-medium text-gray-900">
                {{ product.metadata.price_formatted }}
            </p>
            {% endif %}
            {% if product.metadata.get('rating_formatted') %}
            <p class="text-xs text-gray-500">
                ‚≠ê {{ product.metadata.rating_formatted }}
                {% if product.metadata.get('rating_count') %}
                ({{ product.metadata.rating_count }})
                {% endif %}
            </p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="col-span-3 text-center text-gray-500 mt-8">
    <p>No products found. Try a different search query.</p>
</div>
{% endif %}

<!-- Chat response (hidden, will be picked up by JS) -->
{% if chat_response %}
<div id="chat-response" class="hidden">{{ chat_response }}</div>
<script>
    // IIFE to avoid variable redeclaration on HTMX swaps
    (function() {
        const chatMessages = document.getElementById('chat-messages');
        
        // Remove thinking indicator (it will be re-added on next request)
        const thinkingIndicator = document.getElementById('thinking-indicator');
        if (thinkingIndicator && thinkingIndicator.parentNode) {
            thinkingIndicator.parentNode.removeChild(thinkingIndicator);
        }
        
        // Add agent response to chat
        const chatResponse = document.getElementById('chat-response').textContent;
        if (chatMessages && chatResponse) {
            const agentMessage = document.createElement('div');
            agentMessage.className = 'flex items-center gap-2 fade-in';
            
            const agentAvatar = document.createElement('div');
            agentAvatar.className = 'w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0 overflow-hidden border-2 border-pink-800';
            const agentAvatarImg = document.createElement('img');
            agentAvatarImg.src = '/static/agent-avatar.jpg';
            agentAvatarImg.alt = 'Agent';
            agentAvatarImg.className = 'w-full h-full object-cover rounded-full';
            agentAvatar.appendChild(agentAvatarImg);
            
            const agentMessageBox = document.createElement('div');
            agentMessageBox.className = 'bg-white rounded-lg p-3 border border-gray-200 w-fit max-w-[80%]';
            agentMessageBox.innerHTML = '<p class="text-black">' + chatResponse + '</p>';
            
            agentMessage.appendChild(agentAvatar);
            agentMessage.appendChild(agentMessageBox);
            chatMessages.appendChild(agentMessage);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    })();
</script>
{% endif %}

